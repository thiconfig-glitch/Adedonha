<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Adedonha Deluxe</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#050014">
    <link rel="apple-touch-icon" href="icon.png">

    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root { --bg: #050014; --thiago: #00f3ff; --samella: #ff0055; --roxo: #bd00ff; --amarelo: #ffeb3b; --ouro: #ffd700; --vidro: rgba(255, 255, 255, 0.05); }
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background: var(--bg); 
            background-image: radial-gradient(circle at 50% 20%, #1a0b38 0%, #000 100%);
            color: #fff; font-family: 'Rajdhani', sans-serif; 
            min-height: 100vh; overflow-x: hidden; display: flex; flex-direction: column;
        }

        /* HEADER */
        header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: rgba(0,0,0,0.8); border-bottom: 1px solid #333; position: sticky; top: 0; z-index: 100; }
        .logo { font-family: 'Orbitron'; font-weight: 900; letter-spacing: 2px; background: linear-gradient(90deg, var(--thiago), var(--samella)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .round-badge { border: 1px solid var(--amarelo); color: var(--amarelo); padding: 5px 12px; border-radius: 20px; font-size: 0.9rem; font-family: 'Orbitron'; }

        /* PLACAR */
        #scoreboard { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; margin: 15px; background: var(--vidro); border: 1px solid #333; border-radius: 12px; }
        .score-box { text-align: center; width: 45%; }
        .s-name { font-size: 0.7rem; color: #888; letter-spacing: 1px; }
        .s-val { font-family: 'Orbitron'; font-size: 1.8rem; font-weight: bold; }

        .screen { display: none; padding: 20px; flex-direction: column; align-items: center; flex: 1; animation: fadeIn 0.4s ease; }
        .active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* VISUAL CL√ÅSSICO DA LETRA */
        .roleta-box {
            width: 140px; height: 140px; border-radius: 20px; border: 2px solid var(--roxo);
            display: flex; justify-content: center; align-items: center; margin: 20px 0;
            background: rgba(0,0,0,0.3); box-shadow: 0 0 40px rgba(189, 0, 255, 0.2);
            position: relative; overflow: hidden;
        }
        .roleta-box::before { content:''; position: absolute; width: 100%; height: 5px; background: var(--roxo); top: 0; animation: scan 2s infinite linear; opacity: 0.5; }
        @keyframes scan { 0% {top:0;} 100% {top:100%;} }
        
        #letra-big { font-family: 'Orbitron'; font-size: 5rem; text-shadow: 0 0 20px #fff; z-index: 2; transition: 0.3s; }
        .letra-girando { animation: spin 0.5s ease-in-out; }
        @keyframes spin { 0% { transform: rotateY(0deg); } 100% { transform: rotateY(360deg); } }

        /* TIMER */
        #timer-display { font-family: 'Orbitron'; font-size: 2.5rem; color: var(--amarelo); margin-bottom: 20px; text-shadow: 0 0 15px var(--amarelo); transition: 0.3s; }
        .time-critical { color: #ff0055 !important; animation: pulse 0.5s infinite; }

        /* INPUTS */
        .input-wrap { width: 100%; margin-bottom: 15px; position: relative; }
        .input-tag { position: absolute; top: -10px; left: 10px; background: #050014; padding: 0 8px; color: var(--roxo); font-size: 0.8rem; font-weight: bold; border: 1px solid #333; border-radius: 4px; z-index: 1; }
        .game-input { width: 100%; background: transparent; border: 1px solid #444; border-radius: 10px; color: #fff; padding: 15px; font-size: 1.2rem; font-family: 'Rajdhani'; transition: 0.3s; }
        .game-input:focus { border-color: var(--thiago); outline: none; background: rgba(0, 243, 255, 0.05); }
        .game-input.valido { border-color: #0f0 !important; }
        .game-input.invalido { border-color: #f00 !important; }
        
        /* Indicador de salvamento */
        .save-indicator { position: fixed; top: 80px; right: 20px; background: rgba(0, 255, 0, 0.8); padding: 8px 15px; border-radius: 20px; font-size: 0.8rem; opacity: 0; transition: 0.3s; z-index: 200; }
        .save-indicator.show { opacity: 1; }

        /* BOT√ïES */
        .btn { width: 100%; padding: 18px; border: none; border-radius: 12px; font-family: 'Orbitron'; font-size: 1.1rem; font-weight: bold; color: #fff; cursor: pointer; margin-bottom: 15px; transition: 0.2s; }
        .btn:active { transform: scale(0.98); }
        .btn-girar { background: linear-gradient(45deg, #7b00ff, #bd00ff); box-shadow: 0 0 15px var(--roxo); }
        .btn-stop { background: linear-gradient(45deg, #ff0055, #ff4d00); font-size: 1.5rem; animation: pulse 1.5s infinite; margin-top: 20px; }
        
        .p-card { width: 100%; height: 100px; margin-bottom: 20px; background: rgba(255,255,255,0.05); border: 1px solid #444; border-radius: 15px; display: flex; align-items: center; justify-content: space-between; padding: 25px; cursor: pointer; transition: 0.2s; }
        .p-card:active { transform: scale(0.98); }
        .card-t { border-color: var(--thiago); } .card-s { border-color: var(--samella); }
        
        .res-row { background: rgba(255,255,255,0.03); width: 100%; padding: 12px; margin-bottom: 8px; border-left: 4px solid #555; text-align: left; border-radius: 5px; }
        .res-pts { float: right; font-family: 'Orbitron'; font-weight: bold; }
        .res-adversario { font-size: 0.85rem; color: #888; margin-top: 5px; padding: 5px; background: rgba(0,0,0,0.3); border-radius: 3px; }
        
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
        .hidden { display: none !important; }
        
        #modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:999; display:none; justify-content:center; align-items:center; flex-direction:column; backdrop-filter: blur(5px); }
        .modal-box { background:#151520; padding:25px; border-radius:20px; border:1px solid #333; text-align:center; width:85%; max-width: 320px; }
        .cfg-btn { background: transparent; border: 1px solid #444; color: #888; padding: 12px; margin: 6px 0; width: 100%; border-radius: 8px; cursor: pointer; font-family: 'Orbitron'; transition: 0.2s; }
        .cfg-btn:active { transform: scale(0.98); }
        .cfg-btn.selected { border: 1px solid var(--roxo); color: var(--roxo); background: rgba(189, 0, 255, 0.15); font-weight: bold; }
        
        .info-box { background: rgba(255, 255, 255, 0.05); padding: 10px; border-radius: 8px; margin: 10px 0; font-size: 0.9rem; color: #aaa; }
    </style>
</head>
<body>

    <div class="save-indicator" id="saveIndicator">‚úì Salvo</div>

    <header>
        <div class="logo">ADEDONHA</div>
        <div class="round-badge" id="hud-round">R: 1/10</div>
        <div onclick="toggleMenu()" style="font-size:1.5rem; cursor:pointer;">‚öôÔ∏è</div>
    </header>

    <div id="scoreboard" class="hidden">
        <div class="score-box">
            <div class="s-name">THIAGO</div>
            <div class="s-val" style="color:var(--thiago)" id="hud-thiago">0</div>
        </div>
        <div style="font-family:'Orbitron'; color:#555;">VS</div>
        <div class="score-box">
            <div class="s-name">S√ÇMELLA</div>
            <div class="s-val" style="color:var(--samella)" id="hud-samella">0</div>
        </div>
    </div>

    <div id="screen-password" class="screen active" style="justify-content: center;">
        <h1 style="font-size:4rem; margin-bottom:20px;">üîí</h1>
        <div class="input-wrap">
            <input type="password" id="senha-input" class="game-input" placeholder="Senha..." style="text-align:center;" onkeypress="if(event.key==='Enter')verificarSenha()">
        </div>
        <button class="btn btn-girar" onclick="verificarSenha()">ENTRAR</button>
    </div>

    <div id="screen-login" class="screen">
        <h1 style="font-family:'Orbitron'; margin:30px 0; color:var(--roxo);">BATTLE MODE</h1>
        <div class="p-card card-t" onclick="login('THIAGO')"><span style="font-size:2rem;">üë®üèª</span><span style="font-family:'Orbitron';">THIAGO</span></div>
        <div class="p-card card-s" onclick="login('SAMELLA')"><span style="font-size:2rem;">üë©üèª</span><span style="font-family:'Orbitron';">S√ÇMELLA</span></div>
    </div>

    <div id="screen-game" class="screen">
        <div class="roleta-box"><span id="letra-big">?</span></div>
        <div id="timer-display">05:00</div>
        
        <button class="btn btn-girar" id="btn-spin" onclick="girar()">GIRAR NOVA LETRA</button>
        
        <div id="game-ui" class="hidden" style="width: 100%;">
            <div class="info-box">üí° Todas as respostas devem come√ßar com a letra <strong id="letra-atual-info">?</strong></div>
            <div id="inputs-area" style="width:100%;"></div>
            <button class="btn btn-stop" onclick="darStop()">STOP!</button>
        </div>
    </div>

    <div id="screen-result" class="screen">
        <h2 style="color:var(--amarelo); font-family:'Orbitron'; margin-bottom:20px;">RESULTADOS</h2>
        <div id="result-list" style="width:100%;"></div>
        <div style="margin: 20px 0; font-size:1.5rem;">TOTAL: <strong id="total-round" style="color:var(--amarelo)">0</strong></div>
        <button class="btn btn-girar" id="btn-next" onclick="proximaRodada()">PR√ìXIMA >></button>
    </div>

    <div id="screen-victory" class="screen" style="justify-content:center;">
        <div style="font-size:6rem;">üèÜ</div>
        <h1 style="color:var(--ouro);">CAMPE√ÉO</h1>
        <h2 id="winner-name" style="font-family:'Orbitron'; font-size:3rem; margin-bottom:40px;">...</h2>
        <div id="placar-final" style="font-size:1.2rem; margin-bottom:30px; color:#aaa;"></div>
        <button class="btn btn-stop" onclick="zerarTudo()">NOVA PARTIDA</button>
    </div>

    <div id="modal">
        <div class="modal-box">
            <h3 style="color:#fff; margin-bottom:15px;">CONFIGURA√á√ïES</h3>
            <button class="cfg-btn selected" id="cfg-5" onclick="setConfig(5)">5 RODADAS</button>
            <button class="cfg-btn" id="cfg-10" onclick="setConfig(10)">10 RODADAS</button>
            <button class="cfg-btn" id="cfg-20" onclick="setConfig(20)">20 RODADAS</button>
            <button class="btn" style="background:#330000; border:1px solid red; color:red; margin-top:20px;" onclick="zerarTudo()">RESETAR TUDO</button>
            <button class="btn" style="background:#000; margin-top:5px;" onclick="toggleMenu()">VOLTAR</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAjgEFZB3_FHelXH9YtCnFYFO4RCGO7Wd8",
            authDomain: "adedonha-8b2a4.firebaseapp.com",
            databaseURL: "https://adedonha-8b2a4-default-rtdb.firebaseio.com",
            projectId: "adedonha-8b2a4",
            storageBucket: "adedonha-8b2a4.firebasestorage.app",
            messagingSenderId: "1061633793316",
            appId: "1:1061633793316:web:e4f9a23ce9e28ae8d2e7b1"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const ref = db.ref('partida_casal');

        if ('serviceWorker' in navigator) navigator.serviceWorker.getRegistrations().then(r => r.forEach(i => i.unregister()));

        let eu = ""; 
        let ele = ""; 
        let maxR = 10; 
        let rodada = 1; 
        let timerInterval = null; 
        let lastLetter = "";
        let letraAtual = "";
        let saveTimeout = null;
        
        const cats = ["Nome", "Animal", "Cor", "Fruta", "Objeto", "CEP", "Profiss√£o", "Marca", "Corpo", "Sogra"];

        function verificarSenha() {
            if (document.getElementById('senha-input').value === 'ceros') {
                document.getElementById('screen-password').classList.remove('active');
                document.getElementById('screen-login').classList.add('active');
            } else {
                alert('SENHA ERRADA!');
                document.getElementById('senha-input').value = '';
            }
        }

        function login(nome) {
            eu = nome; 
            ele = (nome === 'THIAGO') ? 'SAMELLA' : 'THIAGO';
            document.getElementById('screen-login').classList.remove('active');
            document.getElementById('scoreboard').classList.remove('hidden');
            document.getElementById('screen-game').classList.add('active');
            
            const div = document.getElementById('inputs-area');
            div.innerHTML = "";
            cats.forEach(c => { 
                div.innerHTML += `<div class="input-wrap">
                    <span class="input-tag">${c}</span>
                    <input type="text" class="game-input" id="in-${c}" oninput="validarInput('${c}')" autocomplete="off">
                </div>`; 
            });
            ouvirBanco();
        }

        function validarInput(cat) {
            const input = document.getElementById(`in-${cat}`);
            const valor = input.value.trim();
            
            // Remove classes anteriores
            input.classList.remove('valido', 'invalido');
            
            if (valor && letraAtual) {
                const primeiraLetra = valor[0].toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
                if (primeiraLetra === letraAtual) {
                    input.classList.add('valido');
                } else {
                    input.classList.add('invalido');
                }
            }
            
            salvarLocal();
        }

        function salvarLocal() {
            // Cancela salvamento anterior
            if (saveTimeout) clearTimeout(saveTimeout);
            
            // Salva ap√≥s 500ms de inatividade
            saveTimeout = setTimeout(() => {
                let r = {}; 
                cats.forEach(c => r[c] = document.getElementById(`in-${c}`).value);
                ref.child('respostas').child(eu).update(r);
                
                // Mostra indicador
                const indicator = document.getElementById('saveIndicator');
                indicator.classList.add('show');
                setTimeout(() => indicator.classList.remove('show'), 1000);
            }, 500);
        }

        function ouvirBanco() {
            ref.on('value', snap => {
                const d = snap.val() || {};
                
                // HUD
                document.getElementById('hud-thiago').innerText = d.placar_thiago || 0;
                document.getElementById('hud-samella').innerText = d.placar_samella || 0;
                maxR = d.config_max || 10;
                rodada = d.rodada || 1;
                document.getElementById('hud-round').innerText = `R: ${rodada}/${maxR}`;
                
                // Menu ativo
                document.querySelectorAll('.cfg-btn').forEach(b => b.classList.remove('selected'));
                if(document.getElementById(`cfg-${maxR}`)) document.getElementById(`cfg-${maxR}`).classList.add('selected');

                if(d.letra) {
                    letraAtual = d.letra;
                    document.getElementById('letra-big').innerText = d.letra;
                    document.getElementById('letra-atual-info').innerText = d.letra;
                }

                // ESTADOS
                if (d.status === 'ESPERA') {
                    document.getElementById('btn-spin').style.display = 'block';
                    document.getElementById('game-ui').classList.add('hidden');
                    document.getElementById('letra-big').innerText = "?";
                    letraAtual = "";
                    pararTimer();
                    trocarTela('screen-game');
                }
                else if (d.status === 'JOGANDO') {
                    document.getElementById('btn-spin').style.display = 'none';
                    document.getElementById('game-ui').classList.remove('hidden');
                    
                    if (d.deadline) iniciarTimer(d.deadline);
                    
                    // Limpar inputs em nova rodada
                    if (d.limpar_id && d.limpar_id !== lastLetter) {
                        lastLetter = d.limpar_id;
                        document.querySelectorAll('.game-input').forEach(i => {
                            i.value = "";
                            i.classList.remove('valido', 'invalido');
                        });
                    }
                    trocarTela('screen-game');
                }
                else if (d.status === 'STOP') {
                    pararTimer();
                    mostrarResultado(d.respostas, d.quem);
                }
                else if (d.status === 'VITORIA') {
                    pararTimer();
                    trocarTela('screen-victory');
                    const pt = d.placar_thiago || 0;
                    const ps = d.placar_samella || 0;
                    
                    document.getElementById('winner-name').innerText = (pt > ps) ? "THIAGO" : (ps > pt) ? "S√ÇMELLA" : "EMPATE";
                    document.getElementById('placar-final').innerHTML = `
                        <div>Thiago: <strong style="color:var(--thiago)">${pt}</strong> pontos</div>
                        <div>S√¢mella: <strong style="color:var(--samella)">${ps}</strong> pontos</div>
                    `;
                }
            });
        }

        function iniciarTimer(end) {
            if (timerInterval) clearInterval(timerInterval);
            const display = document.getElementById('timer-display');
            display.classList.remove('time-critical');
            
            timerInterval = setInterval(() => {
                const left = end - Date.now();
                if (left <= 0) {
                    clearInterval(timerInterval);
                    display.innerText = "00:00";
                    // Auto-stop apenas se ainda estiver jogando
                    ref.once('value').then(s => { 
                        if(s.val().status === 'JOGANDO') darStop(); 
                    });
                } else {
                    const mins = Math.floor((left/1000/60)%60); 
                    const secs = Math.floor((left/1000)%60);
                    display.innerText = `${mins<10?'0'+mins:mins}:${secs<10?'0'+secs:secs}`;
                    if(left < 10000) display.classList.add('time-critical');
                }
            }, 1000);
        }
        
        function pararTimer() { 
            if (timerInterval) {
                clearInterval(timerInterval); 
                timerInterval = null;
            }
        }

        function girar() {
            if(rodada > maxR) { 
                alert("FIM DE JOGO! V√° em Configura√ß√µes > Resetar."); 
                return; 
            }
            
            // Anima√ß√£o de giro
            const letraBig = document.getElementById('letra-big');
            letraBig.classList.add('letra-girando');
            setTimeout(() => letraBig.classList.remove('letra-girando'), 500);
            
            const abc = "ABCDEFGHILMNOPQRSTUVZ";
            const l = abc[Math.floor(Math.random() * abc.length)];
            
            ref.update({
                status: 'JOGANDO',
                letra: l,
                deadline: Date.now() + (5 * 60 * 1000),
                respostas: {}, 
                limpar_id: Date.now() 
            });
        }

        function darStop() { 
            salvarLocal(); 
            ref.update({ status: 'STOP', quem: eu }); 
        }

        function mostrarResultado(all, quemParou) {
            trocarTela('screen-result');
            const lista = document.getElementById('result-list'); 
            lista.innerHTML = "";
            
            const m = (all && all[eu]) ? all[eu] : {};
            const o = (all && all[ele]) ? all[ele] : {};
            let t = 0;
            
            cats.forEach(c => {
                let mv = (m[c]||"").trim();
                let ov = (o[c]||"").trim();
                
                // Normaliza para compara√ß√£o
                let mvNorm = mv.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
                let ovNorm = ov.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
                
                let p = 0; 
                let b = "#333";
                let msg = "";
                
                // Valida letra inicial
                const letraCorreta = mvNorm && mvNorm[0] === letraAtual.toLowerCase();
                
                if(mvNorm === "") { 
                    p = 0; b = "#f05"; msg = "Vazio";
                } else if (!letraCorreta) {
                    p = 0; b = "#f50"; msg = `Letra errada (${mv[0]} ‚â† ${letraAtual})`;
                } else if(mvNorm === ovNorm) { 
                    p = 5; b = "#fe0"; msg = "Igual";
                } else { 
                    p = 10; b = "#0ff"; msg = "√önico";
                }
                
                t += p;
                
                lista.innerHTML += `
                    <div class="res-row" style="border-color:${b}">
                        <span class="res-pts">+${p}</span>
                        <div style="font-size:0.7rem;color:#888;">${c} <span style="color:${b}">(${msg})</span></div>
                        <div><strong>${mv || "-"}</strong></div>
                        <div class="res-adversario">${ele}: ${ov || "-"}</div>
                    </div>
                `;
            });
            
            document.getElementById('total-round').innerText = t;
            
            const btn = document.getElementById('btn-next');
            if(rodada >= maxR) { 
                btn.innerText = "VER CAMPE√ÉO üèÜ"; 
                btn.style.background = "var(--ouro)"; 
                btn.style.color = "#000"; 
            } else { 
                btn.innerText = "PR√ìXIMA >>"; 
                btn.style.background = ""; 
                btn.style.color = "#fff"; 
            }

            // CORRE√á√ÉO: Soma pontos apenas para quem parou
            if (quemParou === eu) {
                ref.once('value').then(s => {
                    const d = s.val();
                    const k = `placar_${eu.toLowerCase()}`;
                    ref.child(k).set((d[k] || 0) + t);
                });
            }
        }

        function proximaRodada() {
            if(rodada >= maxR) {
                ref.update({status:'VITORIA'});
            } else { 
                ref.child('rodada').transaction(r => (r || 1) + 1); 
                ref.update({status: 'ESPERA', letra: '?'}); 
                trocarTela('screen-game');
            }
        }

        function trocarTela(id) { 
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); 
            document.getElementById(id).classList.add('active'); 
        }
        
        function toggleMenu() { 
            const m = document.getElementById('modal'); 
            m.style.display = (m.style.display == 'flex') ? 'none' : 'flex'; 
        }
        
        function setConfig(n) { 
            ref.update({ config_max: n }); 
            toggleMenu(); 
        }
        
        function zerarTudo() { 
            if(confirm("ZERAR TUDO E COME√áAR NOVA PARTIDA?")) { 
                ref.update({
                    placar_thiago: 0, 
                    placar_samella: 0, 
                    rodada: 1, 
                    status: 'ESPERA',
                    letra: '?', 
                    respostas: {},
                    quem: null,
                    deadline: null,
                    limpar_id: null
                }); 
                toggleMenu(); 
            } 
        }
    </script>
</body>
    </html>
