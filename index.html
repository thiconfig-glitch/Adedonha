<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Adedonha Tournament Fixed</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0a0a12">
    <link rel="apple-touch-icon" href="icon.png">

    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* --- ESTILOS VISUAIS --- */
        :root { --bg: #0a0a12; --thiago: #00f3ff; --samella: #ff0055; --roxo: #bd00ff; --amarelo: #ffeb3b; --ouro: #ffd700; --vidro: rgba(255, 255, 255, 0.08); }
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background: var(--bg); 
            background-image: radial-gradient(circle at 50% 50%, rgba(20,20,30,1) 0%, rgba(0,0,0,1) 100%);
            color: #fff; font-family: 'Rajdhani', sans-serif; 
            min-height: 100vh; overflow-x: hidden; display: flex; flex-direction: column;
        }

        /* HEADER & PLACAR */
        header {
            display: flex; justify-content: space-between; align-items: center; padding: 15px 20px;
            background: rgba(0,0,0,0.8); border-bottom: 1px solid #333; position: sticky; top: 0; z-index: 100;
        }
        .logo { font-family: 'Orbitron'; font-weight: 900; letter-spacing: 2px; color: #fff; }
        .round-badge { border: 1px solid var(--amarelo); color: var(--amarelo); padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-family: 'Orbitron'; }
        
        #scoreboard {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px; margin: 10px; background: var(--vidro); border: 1px solid #333; border-radius: 12px;
        }
        .score-box { text-align: center; width: 45%; }
        .s-name { font-size: 0.7rem; color: #888; letter-spacing: 1px; }
        .s-val { font-family: 'Orbitron'; font-size: 1.8rem; font-weight: bold; }
        
        /* TELAS */
        .screen { display: none; padding: 20px; flex-direction: column; align-items: center; flex: 1; animation: fadeIn 0.3s ease; }
        .active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* TELA SELE√á√ÉO */
        .p-card {
            width: 100%; max-width: 350px; height: 100px; margin-bottom: 15px;
            background: rgba(255,255,255,0.05); border: 1px solid #444; border-radius: 15px;
            display: flex; align-items: center; justify-content: space-between; padding: 20px; cursor: pointer;
        }
        .card-t { border-color: var(--thiago); }
        .card-s { border-color: var(--samella); }

        /* JOGO */
        .roleta {
            width: 120px; height: 120px; border-radius: 50%; border: 4px solid var(--roxo);
            display: flex; justify-content: center; align-items: center; margin: 10px 0;
            background: rgba(0,0,0,0.5); box-shadow: 0 0 20px var(--roxo);
        }
        #letra-big { font-family: 'Orbitron'; font-size: 4rem; text-shadow: 0 0 10px #fff; }

        .input-wrap { width: 100%; margin-bottom: 12px; position: relative; }
        .input-tag { position: absolute; top: -8px; left: 10px; background: #000; padding: 0 5px; color: var(--roxo); font-size: 0.75rem; font-weight: bold; }
        .game-input {
            width: 100%; background: transparent; border: 1px solid #555; border-radius: 8px;
            color: #fff; padding: 12px; font-size: 1.1rem; font-family: 'Rajdhani';
        }
        .game-input:focus { border-color: var(--thiago); outline: none; background: rgba(255,255,255,0.05); }

        /* BOT√ïES */
        .btn { width: 100%; padding: 18px; border: none; border-radius: 12px; font-family: 'Orbitron'; font-size: 1.1rem; font-weight: bold; color: #fff; cursor: pointer; margin-bottom: 15px; }
        .btn-girar { background: linear-gradient(45deg, #7b00ff, #bd00ff); }
        .btn-stop { background: linear-gradient(45deg, #ff0055, #ff4d00); font-size: 1.5rem; animation: pulse 1.5s infinite; margin-top: 20px; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 0, 85, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(255, 0, 85, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 0, 85, 0); } }

        /* RESULTADOS */
        .res-row { background: rgba(255,255,255,0.05); width: 100%; padding: 10px; margin-bottom: 5px; border-left: 4px solid #555; border-radius: 0 5px 5px 0; text-align: left; }
        .res-cat { font-size: 0.7rem; color: #aaa; text-transform: uppercase; }
        .res-pts { float: right; font-family: 'Orbitron'; font-weight: bold; }

        /* MODAL */
        #modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:999; display:none; justify-content:center; align-items:center; flex-direction:column; }
        .modal-box { background:#222; padding:20px; border-radius:10px; border:1px solid #444; text-align:center; width:80%; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <header>
        <div class="logo">ADEDONHA</div>
        <div class="round-badge" id="hud-round">R: 1/10</div>
        <div onclick="toggleMenu()" style="font-size:1.5rem; cursor:pointer;">‚öôÔ∏è</div>
    </header>

    <div id="scoreboard" class="hidden">
        <div class="score-box">
            <div class="s-name">THIAGO</div>
            <div class="s-val" style="color:var(--thiago)" id="hud-thiago">0</div>
        </div>
        <div style="font-family:'Orbitron'; color:#555;">VS</div>
        <div class="score-box">
            <div class="s-name">S√ÇMELLA</div>
            <div class="s-val" style="color:var(--samella)" id="hud-samella">0</div>
        </div>
    </div>

    <div id="screen-login" class="screen active">
        <h1 style="font-family:'Orbitron'; margin:30px 0; color:var(--roxo);">START GAME</h1>
        <div class="p-card card-t" onclick="login('THIAGO')">
            <span style="font-size:2rem;">üë®üèª</span>
            <span style="font-family:'Orbitron'; font-size:1.2rem;">THIAGO</span>
        </div>
        <div class="p-card card-s" onclick="login('SAMELLA')">
            <span style="font-size:2rem;">üë©üèª</span>
            <span style="font-family:'Orbitron'; font-size:1.2rem;">S√ÇMELLA</span>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div class="roleta"><span id="letra-big">?</span></div>
        <button class="btn btn-girar" onclick="girar()">GIRAR ROLETA</button>
        <div id="inputs-area" style="width:100%;"></div>
        <button class="btn btn-stop" onclick="darStop()">STOP!</button>
    </div>

    <div id="screen-result" class="screen">
        <h2 style="color:var(--amarelo); font-family:'Orbitron'; margin-bottom:20px;">FIM DE RODADA</h2>
        <div id="result-list" style="width:100%;"></div>
        <div style="margin: 20px 0; font-size:1.5rem;">
            TOTAL: <strong id="total-round" style="color:var(--amarelo)">0</strong>
        </div>
        <button class="btn btn-girar" id="btn-next" onclick="proximaRodada()">PR√ìXIMA >></button>
    </div>

    <div id="screen-victory" class="screen" style="justify-content:center;">
        <div style="font-size:5rem;">üèÜ</div>
        <h1 style="color:var(--ouro); margin-bottom:10px;">CAMPE√ÉO</h1>
        <h2 id="winner-name" style="font-family:'Orbitron'; font-size:3rem; margin-bottom:30px;">...</h2>
        <button class="btn btn-stop" onclick="zerarTudo()">NOVA PARTIDA</button>
    </div>

    <div id="modal">
        <div class="modal-box">
            <h3 style="color:#fff; margin-bottom:15px;">CONFIGURA√á√ïES</h3>
            <button class="btn" style="background:#333; font-size:0.9rem;" onclick="setConfig(5)">JOGO R√ÅPIDO (5)</button>
            <button class="btn" style="background:#333; font-size:0.9rem;" onclick="setConfig(10)">JOGO NORMAL (10)</button>
            <button class="btn" style="background:#330000; border:1px solid red; color:red; margin-top:10px;" onclick="zerarTudo()">RESETAR TUDO</button>
            <button class="btn" style="background:#000; margin-top:10px;" onclick="toggleMenu()">VOLTAR</button>
        </div>
    </div>

    <script>
        // FIREBASE INIT
        const firebaseConfig = {
            apiKey: "AIzaSyAjgEFZB3_FHelXH9YtCnFYFO4RCGO7Wd8",
            authDomain: "adedonha-8b2a4.firebaseapp.com",
            databaseURL: "https://adedonha-8b2a4-default-rtdb.firebaseio.com",
            projectId: "adedonha-8b2a4",
            storageBucket: "adedonha-8b2a4.firebasestorage.app",
            messagingSenderId: "1061633793316",
            appId: "1:1061633793316:web:e4f9a23ce9e28ae8d2e7b1"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const ref = db.ref('partida_casal');

        // CACHE CLEANUP
        if ('serviceWorker' in navigator) navigator.serviceWorker.getRegistrations().then(r => r.forEach(i => i.unregister()));

        // VARS
        let eu = "";
        let ele = "";
        let maxR = 10;
        let rodada = 1;
        let lastLetter = ""; 
        const cats = ["Nome", "Animal", "Cor", "Fruta", "Objeto", "CEP", "Profiss√£o", "Marca", "Corpo", "Sogra"];

        // SETUP INICIAL
        function login(nome) {
            eu = nome;
            ele = (nome === 'THIAGO') ? 'SAMELLA' : 'THIAGO';
            document.getElementById('screen-login').classList.remove('active');
            document.getElementById('scoreboard').classList.remove('hidden');
            document.getElementById('screen-game').classList.add('active');
            
            // GERA INPUTS APENAS UMA VEZ
            const div = document.getElementById('inputs-area');
            div.innerHTML = "";
            cats.forEach(c => {
                div.innerHTML += `
                    <div class="input-wrap">
                        <span class="input-tag">${c}</span>
                        <input type="text" class="game-input" id="in-${c}" oninput="salvarLocal()" autocomplete="off">
                    </div>`;
            });
            
            ouvirBanco();
        }

        function salvarLocal() {
            let r = {};
            cats.forEach(c => r[c] = document.getElementById(`in-${c}`).value);
            ref.child('respostas').child(eu).update(r);
        }

        function ouvirBanco() {
            ref.on('value', snap => {
                const d = snap.val() || {};
                
                // Atualiza HUD
                document.getElementById('hud-thiago').innerText = d.placar_thiago || 0;
                document.getElementById('hud-samella').innerText = d.placar_samella || 0;
                maxR = d.config_max || 10;
                rodada = d.rodada || 1;
                document.getElementById('hud-round').innerText = `R: ${rodada}/${maxR}`;
                
                // Atualiza Letra
                if(d.letra) document.getElementById('letra-big').innerText = d.letra;

                // CONTROLE DE TELAS
                if (d.status === 'STOP') {
                    mostrarResultado(d.respostas);
                } 
                else if (d.status === 'JOGANDO') {
                    trocarTela('screen-game');
                    // S√≥ limpa se a flag mudou (evita limpar enquanto digita)
                    if (d.limpar_id && d.limpar_id !== lastLetter) {
                        lastLetter = d.limpar_id;
                        document.querySelectorAll('input').forEach(i => i.value = "");
                    }
                } 
                else if (d.status === 'VITORIA') {
                    trocarTela('screen-victory');
                    let pt = d.placar_thiago || 0;
                    let ps = d.placar_samella || 0;
                    let w = (pt > ps) ? "THIAGO" : (ps > pt) ? "S√ÇMELLA" : "EMPATE";
                    let c = (pt > ps) ? "var(--thiago)" : (ps > pt) ? "var(--samella)" : "#fff";
                    document.getElementById('winner-name').innerText = w;
                    document.getElementById('winner-name').style.color = c;
                }
            });
        }

        function girar() {
            if(rodada > maxR) { ref.update({status:'VITORIA'}); return; }
            const abc = "ABCDEFGHILMNOPQRSTUVZ";
            const l = abc[Math.floor(Math.random() * abc.length)];
            
            ref.update({
                status: 'JOGANDO',
                letra: l,
                respostas: {}, // Limpa respostas no banco
                limpar_id: Date.now() // Token unico pra for√ßar limpeza local
            });
        }

        function darStop() {
            salvarLocal(); // Salva ultima vez
            ref.update({ status: 'STOP', quem: eu });
        }

        function mostrarResultado(allResps) {
            trocarTela('screen-result');
            const lista = document.getElementById('result-list');
            lista.innerHTML = "";
            
            const meus = (allResps && allResps[eu]) ? allResps[eu] : {};
            const dele = (allResps && allResps[ele]) ? allResps[ele] : {};
            let total = 0;

            cats.forEach(c => {
                let m = (meus[c] || "").trim();
                let o = (dele[c] || "").trim();
                let mN = m.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                let oN = o.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");

                let p = 0; let color = "#fff"; let border = "#333";
                if(mN === "") { p = 0; border="#f05"; color="#f05"; }
                else if(mN === oN) { p = 5; border="#fe0"; color="#fe0"; }
                else { p = 10; border="#0ff"; color="#0ff"; }
                
                total += p;
                
                lista.innerHTML += `
                    <div class="res-row" style="border-color:${border}">
                        <div class="res-cat">${c} <span class="res-pts" style="color:${color}">+${p}</span></div>
                        <div style="font-size:1.1rem;">${m || "-"}</div>
                        <div style="font-size:0.8rem; color:#666;">${ele}: ${o || "-"}</div>
                    </div>`;
            });
            
            document.getElementById('total-round').innerText = total;

            // BOT√ÉO PR√ìXIMO
            const btn = document.getElementById('btn-next');
            if(rodada >= maxR) {
                btn.innerText = "VER CAMPE√ÉO üèÜ";
                btn.style.background = "var(--ouro)";
                btn.style.color = "#000";
            } else {
                btn.innerText = "PR√ìXIMA RODADA >>";
                btn.style.background = "";
            }

            // ATUALIZA PLACAR (S√ì QUEM DEU STOP PRA N√ÉO DUPLICAR)
            ref.once('value').then(s => {
                const d = s.val();
                if(d.quem === eu) {
                    let key = `placar_${eu.toLowerCase()}`;
                    let atual = d[key] || 0;
                    ref.child(key).set(atual + total);
                } else {
                    // Fallback de seguran√ßa local
                     let key = `placar_${eu.toLowerCase()}`;
                     let atual = d[key] || 0;
                     ref.child(key).set(atual + total);
                }
            });
        }

        function proximaRodada() {
            if(rodada >= maxR) {
                ref.update({status:'VITORIA'});
            } else {
                ref.child('rodada').transaction(r => (r||1)+1);
                girar();
            }
        }

        function trocarTela(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function toggleMenu() {
            const m = document.getElementById('modal');
            m.style.display = (m.style.display == 'flex') ? 'none' : 'flex';
        }

        function setConfig(n) {
            ref.update({ config_max: n });
            alert('Configurado para ' + n + ' rodadas!');
            toggleMenu();
        }

        function zerarTudo() {
            if(confirm("ZERAR TUDO?")) {
                ref.update({
                    placar_thiago: 0, placar_samella: 0,
                    rodada: 1, status: 'JOGANDO', letra: '?',
                    respostas: {}
                });
                toggleMenu();
            }
        }
    </script>
</body>
</html>
